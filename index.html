<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DP Moto">
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-180.png">
  <title>DP Moto</title>
  <style>
    @font-face {
      font-family: 'Alagard';
      src: url('/assets/fonts/alagard.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: block;
    }
    @font-face {
      font-family: 'Early GameBoy';
      src: url('/assets/fonts/Early GameBoy.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: block;
    }
    @font-face {
      font-family: 'Retro Gaming';
      src: url('/assets/fonts/Retro Gaming.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: block;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%;
      height: 100dvh;           /* dynamic viewport — tracks actual visible area on iOS */
      background: #000;
      overflow: hidden;
      cursor: none;
      overscroll-behavior: none; /* prevent pull-to-refresh (non-Safari) */
      position: fixed;           /* prevent iOS Safari scroll quirks */
      top: 0; left: 0; right: 0; bottom: 0;
    }
    #game-container {
      width: 100%;
      height: 100%;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      touch-action: none;
      /* Render behind notch on notched iPhones in landscape */
      padding-left: env(safe-area-inset-left, 0px);
      padding-right: env(safe-area-inset-right, 0px);
    }
    #game-container canvas {
      touch-action: none;
    }

    /* ===== BIOS BOOT OVERLAY ===== */
    /* ---- CRT TUNING (edit these) ---- */
    :root {
      --bios-color:             #ff2a2a;   /* main text & bar color            */
      --bios-glow:              #aa0000;   /* outer glow / shadow color        */
      --bios-glow-bright:       #ff6666;   /* inner highlight on bar           */
      --bios-glow-radius:       8px;       /* text-shadow glow spread          */
      --bios-scanline-opacity:  0.5;      /* scanline darkness (0 = off)      */
      --bios-scanline-gap:      3px;       /* px between scanlines             */
      --bios-vignette-start:    50%;       /* vignette transparent center      */
      --bios-vignette-opacity:  0.6;       /* vignette edge darkness           */
      --bios-flicker-speed:     0.08s;     /* flicker animation cycle          */
      --bios-flicker-min:       0.97;      /* min opacity during flicker       */
      --bios-jitter-speed:      0.1s;      /* vertical jitter cycle            */
      --bios-jitter-amount:     1px;     /* px of vertical jitter            */
      --bios-font-size:         clamp(12px, 2vw, 18px);
      --bios-line-height:       1.8;
      --bios-title-font:        'Alagard', 'Courier New', monospace;
      --bios-title-size:        clamp(13.8px, 2.59vw, 36.3px);
      --bios-scale:             2;             /* scale multiplier for entire BIOS group     */
      --bios-row-gap:           20px;           /* extra spacing between text rows             */
      --bios-text-top:          -169px;           /* Y offset of first text row within group     */
      --bios-bar-top:           180px;         /* Y offset of loading bar within group        */
      --bios-enter-top:            120px;        /* [ENTER] prompt distance below boot-content top */
      --bios-enter-scale:          .5;           /* [ENTER] prompt scale multiplier             */
      --bios-ver-font:             'Courier New', monospace;  /* version line font (basic monospace) */
      --bios-ver-size:             clamp(7.6px, 1.14vw, 13.3px);  /* version line font size         */
      --bios-ver-offset-x:         0px;          /* version line horizontal nudge (+ = right)   */
      --bios-ver-offset-y:         -40px;          /* version line vertical nudge (+ = down)      */
    }

    #boot-overlay {
      position: fixed;
      inset: 0;
      z-index: 99999;
      background: #000;
      font-family: 'Early GameBoy', 'Courier New', monospace;
      color: var(--bios-color);
      animation: bios-flicker var(--bios-flicker-speed) infinite alternate;
    }
    #boot-overlay.hidden { display: none; }
    #boot-overlay ::selection { background: var(--bios-color); color: #000; }

    /* CRT scanlines overlay */
    #boot-overlay::before {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        rgba(0,0,0,var(--bios-scanline-opacity)) 0px,
        rgba(0,0,0,var(--bios-scanline-opacity)) 1px,
        transparent 1px,
        transparent var(--bios-scanline-gap)
      );
      pointer-events: none;
      z-index: 2;
    }
    /* CRT vignette overlay */
    #boot-overlay::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at center,
        transparent var(--bios-vignette-start),
        rgba(0,0,0,var(--bios-vignette-opacity)) 100%);
      pointer-events: none;
      z-index: 2;
    }

    @keyframes bios-flicker {
      0%   { opacity: 1; }
      100% { opacity: var(--bios-flicker-min); }
    }
    @keyframes bios-jitter {
      0%   { transform: translateY(0); }
      100% { transform: translateY(var(--bios-jitter-amount)); }
    }

    #boot-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(var(--bios-scale));
      width: clamp(240px, 40vw, 420px);
      z-index: 1;
    }
    #boot-lines {
      position: absolute;
      top: var(--bios-text-top);
      left: 0;
      right: 0;
      text-align: left;
      font-size: var(--bios-font-size);
      line-height: var(--bios-line-height);
      text-shadow: 0 0 var(--bios-glow-radius) var(--bios-glow),
                   0 0 2px var(--bios-color);
      animation: bios-jitter var(--bios-jitter-speed) infinite alternate;
      display: flex;
      flex-direction: column;
      gap: var(--bios-row-gap);
    }
    #boot-lines .line {
      white-space: pre;
      visibility: hidden;
    }
    #boot-lines .line.visible {
      visibility: visible;
    }
    #boot-lines .line:first-child {
      font-family: var(--bios-title-font);
      font-size: var(--bios-title-size);
      transform-origin: left center;
    }
    #boot-lines .bios-version {
      font-family: var(--bios-ver-font);
      font-size: var(--bios-ver-size);
      font-weight: bold;
      transform-origin: left center;
      margin-left: var(--bios-ver-offset-x);
      margin-top: var(--bios-ver-offset-y);
    }

    #boot-bar-wrap {
      position: absolute;
      top: var(--bios-bar-top);
      left: 0;
      right: 0;
      height: 14px;
      animation: bios-jitter var(--bios-jitter-speed) infinite alternate;
      border: 1px solid var(--bios-color);
      background: #111;
      box-shadow: 0 0 6px var(--bios-glow);
      overflow: hidden;
    }
    #boot-bar-fill {
      height: 100%;
      width: 10%;
      background: var(--bios-color);
      box-shadow: inset 0 0 4px var(--bios-glow-bright);
      transition: width 0.15s linear;
    }

    /* "[ ENTER ]" prompt — shown after loading finishes, right-aligned with bar */
    #boot-enter-prompt {
      display: none;
      position: absolute;
      top: var(--bios-enter-top);
      right: 0;
      text-align: right;
      font-family: var(--bios-title-font);
      font-size: clamp(24px, 5vw, 56px);
      transform: scale(var(--bios-enter-scale));
      transform-origin: right center;
      color: var(--bios-color);
      text-shadow: 0 0 var(--bios-glow-radius) var(--bios-glow),
                   0 0 2px var(--bios-color);
      z-index: 1;
      animation: enter-blink 1350ms infinite, enter-jitter var(--bios-jitter-speed) infinite alternate;
    }
    @keyframes enter-jitter {
      0%   { transform: scale(var(--bios-enter-scale)) translateY(0); }
      100% { transform: scale(var(--bios-enter-scale)) translateY(var(--bios-jitter-amount)); }
    }
    @keyframes enter-blink {
      0%   { opacity: 1; }
      53%  { opacity: 1; }
      63%  { opacity: 0; }
      83%  { opacity: 0; }
      93%  { opacity: 1; }
      100% { opacity: 1; }
    }
    /* iPad Preview Mode (desktop debug: press I) */
    html.ipad-preview {
      background: #000 !important;
    }
    html.ipad-preview body {
      width: var(--ipad-preview-w, 1180px) !important;
      height: var(--ipad-preview-h, 820px) !important;
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) scale(var(--ipad-preview-scale, 1)) !important;
      overflow: hidden !important;
      outline: 2px solid #333;
      border-radius: 18px;
    }
  </style>
</head>
<body>
  <!-- BIOS boot overlay — renders instantly before any JS -->
  <div id="boot-overlay" data-testid="bios-overlay">
    <!-- Device debug banner — bottom-left, tiny text -->
    <div id="device-debug" style="position:fixed;bottom:4px;left:8px;font-size:10px;color:#660000;font-family:monospace;z-index:100000;opacity:0.7;pointer-events:none"></div>
    <script>
    (function(){
      var w = Math.min(screen.width, screen.height);
      var h = Math.max(screen.width, screen.height);
      var dpr = window.devicePixelRatio;
      var ios = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      var el = document.getElementById('device-debug');
      var sa = (navigator.standalone === true) || (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches);
      if (el) el.textContent = (ios ? 'iOS' : 'other') + ' ' + w + 'x' + h + ' @' + dpr + 'x | cores=' + (navigator.hardwareConcurrency||'?') + ' | mem=' + (navigator.deviceMemory||'?') + 'GB | vp=' + window.innerWidth + 'x' + window.innerHeight + (sa ? ' [SA]' : ' [BR]');
    })();
    </script>
    <div id="boot-content" data-testid="bios-content">
      <div id="boot-lines" data-testid="bios-lines">
        <div class="line" id="bios-title-line" data-text="DP MOTO BIOS      v0.1"></div>
        <div class="line bios-version" data-text=""></div>
        <div class="line" data-text="VIDEO  ............... OK"></div>
        <div class="line" data-text="AUDIO  ............. SURE"></div>
        <div class="line" data-text="LOADING GAME ........ WTV"></div>
      </div>
      <div id="boot-bar-wrap" data-testid="bios-loading-bar">
        <div id="boot-bar-fill" data-testid="bios-loading-fill"></div>
      </div>
      <div id="boot-enter-prompt" data-testid="bios-enter-prompt" aria-label="Press Enter">[ ENTER ]</div>
    </div>
  </div>

  <script>
  // ---- CURSOR TUNING (shared between BIOS overlay & in-game) ----
  window.__cursorConfig = {
    size: 40,              // display height in px
    strokeW: 6.9,            // stroke thickness in px (0 = no stroke)
    tint: 0xff0000,        // fill color (red)
    strokeColor: 0x000000, // stroke color (white)
    offsetX: 12,           // px offset to align tip with real cursor (+ = right)
    offsetY: 20,           // px offset to align tip with real cursor (+ = down)
  };

  // Prevent unhandled errors from crashing iOS Safari (which reloads the page)
  // Also show errors visually on the device debug banner for diagnosis
  window.__errorLog = [];
  window.addEventListener('error', function(e) {
    var msg = (e.error && e.error.stack) ? e.error.stack.substring(0, 200) : (e.message || 'unknown');
    console.error('Uncaught error:', msg);
    window.__errorLog.push('ERR: ' + msg);
    var el = document.getElementById('device-debug');
    if (el) el.textContent += ' | ERR: ' + (e.message || 'unknown').substring(0, 80);
    e.preventDefault();
  });
  window.addEventListener('unhandledrejection', function(e) {
    var msg = (e.reason && e.reason.stack) ? e.reason.stack.substring(0, 200) : String(e.reason || 'unknown');
    console.error('Unhandled rejection:', msg);
    window.__errorLog.push('REJ: ' + msg);
    var el = document.getElementById('device-debug');
    if (el) el.textContent += ' | REJ: ' + String(e.reason || 'unknown').substring(0, 80);
    e.preventDefault();
  });

  // Boot overlay API — available immediately, before any module JS loads
  (function() {
    /* ---- TYPEWRITER TUNING (edit these) ---- */
    var DOT_TIME_PERCENT = 0.85;  // fraction of loading progress that dots consume
    var DOT_POP_MS       = 60;    // min ms between each dot popping on
    var WORD_POP_MS      = 30;    // ms pause after a word chunk appears

    // Populate version line with timestamp and scale to match title width
    (function() {
      var now = new Date();
      var dd = String(now.getDate()).padStart(2, '0');
      var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      var monthName = monthNames[now.getMonth()];
      var yyyy = String(now.getFullYear());
      var hh = String(now.getHours()).padStart(2, '0');
      var mi = String(now.getMinutes()).padStart(2, '0');
      var ss = String(now.getSeconds()).padStart(2, '0');
      var verNum = '0.00.59';
      var versionText = 'last saved [ ' + dd + ' : ' + monthName + ' : ' + yyyy + ' ]  [ ' + hh + ' : ' + mi + ' : ' + ss + ' ]';
      // Set title line version dynamically
      var titleLine = document.getElementById('bios-title-line');
      if (titleLine) titleLine.setAttribute('data-text', 'DP MOTO BIOS      v' + verNum);
      var versionEl = document.querySelector('.bios-version');
      if (versionEl) {
        versionEl.setAttribute('data-text', versionText);
      }

      // Auto-fit: if title or version line overflows the container, shrink with scaleX
      // Font sizes from CSS vars set the base; this just clamps overflow
      function autoFitLines() {
        var barEl = document.getElementById('boot-bar-wrap');
        if (!barEl) return;
        var targetW = barEl.getBoundingClientRect().width;
        if (targetW <= 0) return;

        var linesToFit = [titleLine, versionEl];
        for (var fi = 0; fi < linesToFit.length; fi++) {
          var el = linesToFit[fi];
          if (!el) continue;
          // Temporarily reveal + reset transform to measure natural width
          var prevVis = el.style.visibility;
          var prevText = el.textContent;
          el.style.visibility = 'visible';
          el.textContent = el.getAttribute('data-text') || '';
          el.style.transform = '';
          el.style.transformOrigin = 'left center';
          var naturalW = el.getBoundingClientRect().width;
          if (naturalW > targetW && naturalW > 0) {
            el.style.transform = 'scaleX(' + (targetW / naturalW) + ')';
          }
          // Restore — typewriter will reveal later
          el.style.visibility = prevVis;
          el.textContent = prevText;
        }
      }
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(autoFitLines);
      } else {
        setTimeout(autoFitLines, 100);
      }
      // Re-fit on resize so it tracks container width changes
      window.addEventListener('resize', function() {
        if (document.getElementById('boot-overlay').classList.contains('hidden')) return;
        autoFitLines();
      });
    })();

    var fill = document.getElementById('boot-bar-fill');
    var lineEls = document.querySelectorAll('#boot-lines .line');
    var overlay = document.getElementById('boot-overlay');
    var bootLinesEl = document.getElementById('boot-lines');
    var enterPrompt = document.getElementById('boot-enter-prompt');
    var bootContent = document.getElementById('boot-content');
    var biosStarted = true;  // start BIOS immediately (no terminal phase)
    var readyForEnter = false;  // true once loading bar finishes

    // Click sound during BIOS overlay
    var biosClickAudio = new Audio('assets/audio/sfx/mouse click.mp3');
    biosClickAudio.volume = 1.0;
    overlay.addEventListener('pointerdown', function() {
      biosClickAudio.currentTime = 0;
      biosClickAudio.play().catch(function() {});
    });

    // Boot-up sound — try autoplay, fallback to mousemove, then click/key
    var bootupAudio = new Audio('assets/audio/sfx/old_bootup.mp3');
    bootupAudio.volume = 1.0;
    bootupAudio.loop = false;
    var bootAudioStarted = false;
    function tryPlayBootAudio() {
      if (bootAudioStarted) return;
      bootupAudio.play().then(function() {
        bootAudioStarted = true;
        document.removeEventListener('mousemove', tryPlayBootAudio);
        document.removeEventListener('pointerdown', tryPlayBootAudio);
        document.removeEventListener('keydown', tryPlayBootAudio);
      }).catch(function() {});
    }
    // Attempt 1: autoplay immediately
    tryPlayBootAudio();
    // Attempt 2: on mouse move
    document.addEventListener('mousemove', tryPlayBootAudio);
    // Attempt 3: on click or keypress
    document.addEventListener('pointerdown', tryPlayBootAudio);
    document.addEventListener('keydown', tryPlayBootAudio);

    // Dismiss handler — any key or tap after [ENTER] prompt is shown
    var guideMode = false; // debug guide mode blocks dismiss
    var dismissPointerStart = 0;
    var BIOS_TAP_THRESHOLD = 250; // ms — touch shorter than this = tap
    function handleDismissDown() {
      if (guideMode) return;
      dismissPointerStart = Date.now();
    }
    function handleDismissUp() {
      if (guideMode) return;
      if (!readyForEnter) return;
      if (Date.now() - dismissPointerStart < BIOS_TAP_THRESHOLD) {
        dismissOverlay();
      }
    }
    function handleDismissKey(e) {
      if (guideMode) return;
      if (!readyForEnter) return;
      if (e && e.key === 'g') return; // let G through to toggle guide
      dismissOverlay();
    }
    document.addEventListener('pointerdown', handleDismissDown);
    document.addEventListener('pointerup', handleDismissUp);
    document.addEventListener('keydown', handleDismissKey);
    // Allow programmatic click() on enter prompt to dismiss (for WebDriver/act.mjs)
    enterPrompt.addEventListener('click', function() {
      if (!readyForEnter || dismissed) return;
      dismissOverlay();
    });

    // Build flat character list, count dots/non-dots, assign progress thresholds
    var chars = [];
    var totalDots = 0;
    var totalNonDots = 0;
    for (var i = 0; i < lineEls.length; i++) {
      var text = lineEls[i].getAttribute('data-text') || '';
      lineEls[i].textContent = '';
      for (var j = 0; j < text.length; j++) {
        var isDot = text[j] === '.';
        chars.push({ el: lineEls[i], idx: j, fullText: text, isDot: isDot, threshold: 0 });
        if (isDot) totalDots++; else totalNonDots++;
      }
    }

    // Each dot eats DOT_TIME_PERCENT/totalDots of the progress range;
    // each non-dot eats (1-DOT_TIME_PERCENT)/totalNonDots — words fly through.
    var dotW    = totalDots    > 0 ? DOT_TIME_PERCENT / totalDots : 0;
    var nonDotW = totalNonDots > 0 ? (1 - DOT_TIME_PERCENT) / totalNonDots : 0;
    var cum = 0;
    for (var k = 0; k < chars.length; k++) {
      cum += chars[k].isDot ? dotW : nonDotW;
      chars[k].threshold = cum;
    }

    var revealed = 0;
    var targetProgress = 0;
    var typingDone = false;
    var loadingDone = false;
    var dismissed = false;
    var dripScheduled = false;

    // Skip BIOS after Spotify auth redirect (prevents double-boot on Safari)
    if (sessionStorage.getItem('skip_bios')) {
      sessionStorage.removeItem('skip_bios');
      dismissed = true;
      overlay.classList.add('hidden');
    }

    // Drip: reveal one item per tick, only if loading progress allows it
    function drip() {
      dripScheduled = false;
      if (revealed >= chars.length) { typingDone = true; syncBar(); tryDismiss(); return; }
      if (chars[revealed].threshold > targetProgress) return; // wait for more progress

      var c = chars[revealed];
      if (c.isDot) {
        if (!c.el.classList.contains('visible')) c.el.classList.add('visible');
        c.el.textContent = c.fullText.substring(0, c.idx + 1);
        revealed++;
        syncBar();
        scheduleDrip(DOT_POP_MS);
      } else {
        // Batch all consecutive non-dots whose thresholds are earned
        while (revealed < chars.length && !chars[revealed].isDot && chars[revealed].threshold <= targetProgress) {
          var ch = chars[revealed];
          if (!ch.el.classList.contains('visible')) ch.el.classList.add('visible');
          ch.el.textContent = ch.fullText.substring(0, ch.idx + 1);
          revealed++;
        }
        syncBar();
        scheduleDrip(WORD_POP_MS);
      }
    }

    // Bar tracks typewriter progress, not raw load progress
    function syncBar() {
      var pct = chars.length > 0 ? (revealed / chars.length) * 100 : 0;
      fill.style.width = pct + '%';
    }

    function scheduleDrip(delay) {
      if (dripScheduled) return;
      if (revealed >= chars.length) { typingDone = true; tryDismiss(); return; }
      if (chars[revealed].threshold <= targetProgress) {
        dripScheduled = true;
        setTimeout(drip, delay);
      }
    }

    function revealAll() {
      for (var m = 0; m < lineEls.length; m++) {
        lineEls[m].classList.add('visible');
        lineEls[m].textContent = lineEls[m].getAttribute('data-text') || '';
      }
      revealed = chars.length;
      typingDone = true;
    }

    function fadeOutBootAudio() {
      var start = bootupAudio.volume;
      var dur = 500; // ms
      var step = 16;
      var decrement = start / (dur / step);
      var fade = setInterval(function() {
        var v = bootupAudio.volume - decrement;
        if (v <= 0) {
          clearInterval(fade);
          bootupAudio.volume = 0;
          bootupAudio.pause();
        } else {
          bootupAudio.volume = v;
        }
      }, step);
    }

    // BIOS complete chime — plays when loading finishes
    var biosCompleteAudio = new Audio('assets/audio/sfx/bios complete loading.mp3');
    biosCompleteAudio.volume = 1.0;
    var beepDone = false;
    var beepCallback = null;

    function onBeepFinished() {
      if (beepDone) return;
      beepDone = true;
      if (beepCallback) beepCallback();
    }
    biosCompleteAudio.addEventListener('ended', onBeepFinished, { once: true });
    biosCompleteAudio.addEventListener('error', onBeepFinished, { once: true });

    function tryDismiss() {
      if (readyForEnter || !typingDone || !loadingDone) return;
      // Loading done — show [ENTER] prompt, wait for user input
      readyForEnter = true;
      biosCompleteAudio.play().catch(function() { onBeepFinished(); });
      enterPrompt.style.display = 'block';
    }

    function dismissOverlay() {
      if (dismissed) return;
      dismissed = true;
      fadeOutBootAudio();

      // iOS audio unlock — must happen synchronously inside user gesture.
      // Create + resume an AudioContext so all subsequent Web Audio / Phaser sound works.
      // Also play+pause a silent HTML5 audio element to unlock <audio> for YouTube/Spotify.
      try {
        var unlockCtx = new (window.AudioContext || window.webkitAudioContext)();
        unlockCtx.resume().then(function() { unlockCtx.close(); });
      } catch(e) {}
      // Unlock Phaser's Web Audio context if it exists
      try {
        var phaserCtx = window.__phaserGame && window.__phaserGame.sound && window.__phaserGame.sound.context;
        if (phaserCtx && phaserCtx.state === 'suspended') phaserCtx.resume();
      } catch(e) {}
      // Unlock HTML5 Audio for YouTube IFrame / Spotify SDK
      try {
        var silentAudio = new Audio();
        silentAudio.src = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=';
        silentAudio.volume = 0;
        silentAudio.play().then(function() { silentAudio.pause(); }).catch(function(){});
      } catch(e) {}
      // Activate Spotify Web Playback SDK audio element (iOS requires gesture context)
      try {
        if (window.__spotifyPlayer && window.__spotifyPlayer.activateElement) {
          window.__spotifyPlayer.activateElement();
        }
      } catch(e) {}
      // Unlock YouTube IFrame player audio (play+pause during gesture)
      try {
        if (window.__ytPlayer && window.__ytPlayer.playVideo) {
          window.__ytPlayer.playVideo();
          setTimeout(function() {
            try { window.__ytPlayer.pauseVideo(); } catch(e) {}
          }, 50);
        }
      } catch(e) {}

      // Fullscreen API — works on iPad, silently fails on iPhone. Must be in user gesture.
      try {
        var rfs = document.documentElement.requestFullscreen || document.documentElement.webkitRequestFullscreen;
        if (rfs) rfs.call(document.documentElement).catch(function(){});
      } catch(e) {}
      // Orientation lock — works on Android, silently fails on iOS
      try {
        if (screen.orientation && screen.orientation.lock) screen.orientation.lock('landscape').catch(function(){});
      } catch(e) {}

      document.removeEventListener('pointerdown', handleDismissDown);
      document.removeEventListener('pointerup', handleDismissUp);
      document.removeEventListener('keydown', handleDismissKey);
      overlay.style.transition = 'opacity 0.3s ease-out';
      overlay.style.opacity = '0';
      setTimeout(function() {
        overlay.classList.add('hidden');
        if (bootCursor && bootCursor.parentNode) bootCursor.parentNode.removeChild(bootCursor);
      }, 320);
    }

    // Start the drip immediately
    scheduleDrip(0);

    window.__bootOverlay = {
      dismiss: function() {
        if (!readyForEnter || dismissed) return false;
        dismissOverlay();
        return true;
      },
      setProgress: function(p) {
        if (dismissed) return;
        targetProgress = p;
        if (!dripScheduled) scheduleDrip(0);
      },
      markStartScreenReady: function() {
        if (loadingDone) return;
        loadingDone = true;
        targetProgress = 2;
        if (!typingDone && !dripScheduled) scheduleDrip(0);
        tryDismiss();
      },
      waitForBeep: function(cb) {
        if (beepDone) { cb(); return; }
        beepCallback = cb;
      },
      bootupAudio: bootupAudio,
      biosCompleteAudio: biosCompleteAudio,
      biosClickAudio: biosClickAudio
    };

    // ---- TEST MODE AUTO-DISMISS (?test=1) ----
    if (location.search.indexOf('test=1') !== -1) {
      // In test mode, auto-dismiss BIOS after 500ms without user input.
      // Mark loading done immediately and trigger dismiss when typing finishes.
      loadingDone = true;
      targetProgress = 2;
      setTimeout(function() {
        if (!dismissed) {
          readyForEnter = true;
          dismissOverlay();
        }
      }, 500);
    }

    // ---- DEBUG GUIDE MODE (G key during BIOS) ----
    var guideSelectedIdx = 0;
    var guideSizes = [];      // current font-size in px per line
    var guideOrigSizes = [];  // snapshot on enter
    var guideElL = null, guideElR = null, guideLabel = null, guideHL = null;

    function enterGuideMode() {
      guideMode = true;
      // Reveal all lines so they're visible and measurable
      for (var i = 0; i < lineEls.length; i++) {
        lineEls[i].classList.add('visible');
        if (!lineEls[i].textContent) {
          lineEls[i].textContent = lineEls[i].getAttribute('data-text') || '';
        }
        // Strip any scaleX transforms — we're using font-size now
        lineEls[i].style.transform = '';
      }
      // Snapshot current computed font sizes
      guideSizes = [];
      guideOrigSizes = [];
      for (var i = 0; i < lineEls.length; i++) {
        var px = parseFloat(getComputedStyle(lineEls[i]).fontSize) || 14;
        guideSizes.push(px);
        guideOrigSizes.push(px);
      }
      // Green guide lines at loading bar edges
      var barRect = document.getElementById('boot-bar-wrap').getBoundingClientRect();
      guideElL = document.createElement('div');
      guideElL.style.cssText = 'position:fixed;top:0;bottom:0;width:1px;background:rgba(0,255,0,0.5);z-index:100000;pointer-events:none;';
      guideElL.style.left = barRect.left + 'px';
      document.body.appendChild(guideElL);
      guideElR = document.createElement('div');
      guideElR.style.cssText = 'position:fixed;top:0;bottom:0;width:1px;background:rgba(0,255,0,0.5);z-index:100000;pointer-events:none;';
      guideElR.style.left = (barRect.right - 1) + 'px';
      document.body.appendChild(guideElR);
      // HUD label
      guideLabel = document.createElement('div');
      guideLabel.style.cssText = 'position:fixed;top:10px;left:50%;transform:translateX(-50%);color:#0f0;font-family:monospace;font-size:13px;z-index:100001;pointer-events:none;text-align:center;background:rgba(0,0,0,0.85);padding:8px 16px;border:1px solid #0f0;white-space:pre;';
      document.body.appendChild(guideLabel);
      // Highlight box
      guideHL = document.createElement('div');
      guideHL.style.cssText = 'position:fixed;pointer-events:none;z-index:99999;border:1px solid rgba(0,255,0,0.6);background:rgba(0,255,0,0.06);';
      document.body.appendChild(guideHL);
      guideSelectedIdx = 0;
      updateGuideUI();
    }

    function exitGuideMode() {
      guideMode = false;
      if (guideElL) { guideElL.remove(); guideElL = null; }
      if (guideElR) { guideElR.remove(); guideElR = null; }
      if (guideLabel) { guideLabel.remove(); guideLabel = null; }
      if (guideHL) { guideHL.remove(); guideHL = null; }
    }

    function updateGuideUI() {
      var el = lineEls[guideSelectedIdx];
      var rect = el.getBoundingClientRect();
      if (guideHL) {
        guideHL.style.left = rect.left + 'px';
        guideHL.style.top = rect.top + 'px';
        guideHL.style.width = rect.width + 'px';
        guideHL.style.height = rect.height + 'px';
      }
      var txt = (el.getAttribute('data-text') || '').substring(0, 35);
      var orig = guideOrigSizes[guideSelectedIdx];
      var cur = guideSizes[guideSelectedIdx];
      var delta = cur - orig;
      if (guideLabel) {
        guideLabel.textContent =
          'GUIDE MODE  [G]=exit  [\u2191\u2193]=select  [\u2190\u2192]=size  [Shift]=fine  [Enter]=copy\n' +
          'Line ' + guideSelectedIdx + '/' + (lineEls.length - 1) + ': "' + txt + '"\n' +
          'fontSize: ' + cur.toFixed(2) + 'px  (orig: ' + orig.toFixed(2) + 'px  delta: ' + (delta >= 0 ? '+' : '') + delta.toFixed(2) + 'px)';
      }
    }

    function adjustGuideFontSize(delta) {
      guideSizes[guideSelectedIdx] += delta;
      if (guideSizes[guideSelectedIdx] < 1) guideSizes[guideSelectedIdx] = 1;
      lineEls[guideSelectedIdx].style.fontSize = guideSizes[guideSelectedIdx] + 'px';
      updateGuideUI();
    }

    function copyGuideChanges() {
      var msg = 'BIOS GUIDE DEBUG \u2014 paste this so Claude can apply changes:\n';
      var hasChanges = false;
      for (var i = 0; i < lineEls.length; i++) {
        var orig = guideOrigSizes[i];
        var cur = guideSizes[i];
        if (Math.abs(cur - orig) > 0.05) {
          hasChanges = true;
          var txt = (lineEls[i].getAttribute('data-text') || '').substring(0, 50);
          msg += 'Line ' + i + ' ("' + txt + '"): fontSize ' + orig.toFixed(2) + 'px -> ' + cur.toFixed(2) + 'px  (ratio: ' + (cur / orig).toFixed(6) + ')\n';
        }
      }
      if (!hasChanges) msg += 'No changes made.\n';
      navigator.clipboard.writeText(msg).then(function() {
        if (guideLabel) guideLabel.textContent += '\n\u2705 Copied to clipboard!';
      });
    }

    // Click on lines to select them during guide mode
    for (var gi = 0; gi < lineEls.length; gi++) {
      (function(idx) {
        lineEls[idx].addEventListener('click', function() {
          if (!guideMode) return;
          guideSelectedIdx = idx;
          updateGuideUI();
        });
      })(gi);
    }

    // Guide mode keyboard handler — capture phase fires before dismiss handler
    document.addEventListener('keydown', function(e) {
      if (dismissed) return;
      // G toggles guide mode (works even before [ENTER] prompt)
      if (e.key === 'g' || e.key === 'G') {
        if (!guideMode) { enterGuideMode(); } else { exitGuideMode(); }
        e.preventDefault();
        e.stopImmediatePropagation();
        return;
      }
      if (!guideMode) return;
      e.preventDefault();
      e.stopImmediatePropagation();
      var step = e.shiftKey ? 0.1 : 0.5; // px
      if (e.key === 'ArrowUp') {
        guideSelectedIdx = (guideSelectedIdx - 1 + lineEls.length) % lineEls.length;
        updateGuideUI();
      } else if (e.key === 'ArrowDown') {
        guideSelectedIdx = (guideSelectedIdx + 1) % lineEls.length;
        updateGuideUI();
      } else if (e.key === 'ArrowLeft') {
        adjustGuideFontSize(-step);
      } else if (e.key === 'ArrowRight') {
        adjustGuideFontSize(step);
      } else if (e.key === 'Enter') {
        copyGuideChanges();
      }
    }, true); // capture phase

    // --- Custom cursor (reads from window.__cursorConfig) ---
    var cc = window.__cursorConfig;
    var bootCursor = document.createElement('div');
    bootCursor.style.cssText = 'position:fixed;pointer-events:none;z-index:1;display:none;' +
      'animation:bios-jitter var(--bios-jitter-speed) infinite alternate;';
    var cursorImg = new Image();
    cursorImg.onload = function() {
      var aspect = cursorImg.naturalWidth / cursorImg.naturalHeight;
      var h = cc.size;
      var sw = cc.strokeW;
      var mainH = h, mainW = Math.round(h * aspect);
      var tintHex = '#' + cc.tint.toString(16).padStart(6, '0');
      var strokeHex = '#' + cc.strokeColor.toString(16).padStart(6, '0');
      var mask = '-webkit-mask-image:url(ui/cursor.png);mask-image:url(ui/cursor.png);' +
        '-webkit-mask-size:contain;mask-size:contain;' +
        '-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;' +
        '-webkit-mask-position:center;mask-position:center;' +
        'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);';
      if (sw > 0) {
        var sH = h + sw * 2, sW = Math.round(sH * aspect);
        var strokeDiv = document.createElement('div');
        strokeDiv.style.cssText = mask + 'width:' + sW + 'px;height:' + sH + 'px;background:' + strokeHex + ';';
        bootCursor.appendChild(strokeDiv);
      }
      var mainDiv = document.createElement('div');
      mainDiv.style.cssText = mask + 'width:' + mainW + 'px;height:' + mainH + 'px;background:' + tintHex + ';';
      bootCursor.appendChild(mainDiv);
      overlay.appendChild(bootCursor);
    };
    cursorImg.src = 'ui/cursor.png';
    function updateBootCursor(clientX, clientY) {
      if (dismissed) return;
      bootCursor.style.display = '';
      bootCursor.style.left = (clientX + (cc.offsetX || 0)) + 'px';
      bootCursor.style.top = (clientY + (cc.offsetY || 0)) + 'px';
    }
    document.addEventListener('mousemove', function(e) { updateBootCursor(e.clientX, e.clientY); });
    document.addEventListener('pointerdown', function(e) { updateBootCursor(e.clientX, e.clientY); });
    document.addEventListener('pointermove', function(e) { updateBootCursor(e.clientX, e.clientY); });
  })();

  // ---- iPad Preview Mode (I key — desktop only) ----
  (function() {
    // Skip on actual mobile/tablet devices — this is a desktop debug tool
    var isMobile = /iPad|iPhone|iPod|Android/i.test(navigator.userAgent) ||
      (navigator.maxTouchPoints > 1 && /Mac/.test(navigator.userAgent));
    if (isMobile) return;

    // iPad 10th gen landscape viewport sizes (CSS px)
    var MODES = {
      webapp:  { w: 1180, h: 820, label: 'Web App (standalone)' },
      browser: { w: 1180, h: 764, label: 'Safari Browser' }
    };
    var active = false;
    var mode = 'webapp'; // 'webapp' or 'browser'
    var label = null;

    function currentMode() { return MODES[mode]; }

    function calcScale() {
      var m = currentMode();
      document.documentElement.style.setProperty('--ipad-preview-w', m.w + 'px');
      document.documentElement.style.setProperty('--ipad-preview-h', m.h + 'px');
      var s = Math.min(window.innerHeight / m.h, window.innerWidth / m.w);
      document.documentElement.style.setProperty('--ipad-preview-scale', s);
    }

    function updateLabel() {
      if (!label) return;
      var m = currentMode();
      label.textContent = 'iPad 10th gen (' + m.w + '\u00d7' + m.h + ' @2x) \u2014 ' + m.label + '  [B]=toggle  [I]=exit';
    }

    function enter() {
      active = true;
      document.documentElement.classList.add('ipad-preview');
      calcScale();
      window.addEventListener('resize', calcScale);
      // Label outside body transform (appended to html element)
      label = document.createElement('div');
      label.style.cssText = 'position:fixed;bottom:8px;left:50%;transform:translateX(-50%);color:#0ff;font-family:monospace;font-size:12px;z-index:200000;pointer-events:none;background:rgba(0,0,0,0.85);padding:4px 12px;border:1px solid #0ff;white-space:nowrap;';
      updateLabel();
      document.documentElement.appendChild(label);
      setTimeout(function() { window.dispatchEvent(new Event('resize')); }, 50);
    }

    function exit() {
      active = false;
      document.documentElement.classList.remove('ipad-preview');
      document.documentElement.style.removeProperty('--ipad-preview-scale');
      document.documentElement.style.removeProperty('--ipad-preview-w');
      document.documentElement.style.removeProperty('--ipad-preview-h');
      window.removeEventListener('resize', calcScale);
      if (label) { label.remove(); label = null; }
      setTimeout(function() { window.dispatchEvent(new Event('resize')); }, 50);
    }

    function toggleMode() {
      mode = (mode === 'webapp') ? 'browser' : 'webapp';
      calcScale();
      updateLabel();
      setTimeout(function() { window.dispatchEvent(new Event('resize')); }, 50);
    }

    document.addEventListener('keydown', function(e) {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.key === 'i' || e.key === 'I') {
        if (active) exit(); else enter();
        e.preventDefault();
        e.stopImmediatePropagation();
      } else if ((e.key === 'b' || e.key === 'B') && active) {
        toggleMode();
        e.preventDefault();
        e.stopImmediatePropagation();
      }
    }, true);
  })();
  </script>

  <div id="game-container"></div>
  <!-- Phaser loaded via CDN to avoid Vite pre-bundling crash on iOS Safari -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.90.0/dist/phaser.min.js"></script>
  <script type="module" src="/src/main.ts"></script>

  <!-- Edge swipe prevention — block Safari back/forward gestures near screen edges -->
  <script>
  (function(){
    document.addEventListener('touchstart', function(e) {
      var t = e.touches[0];
      if (!t) return;
      var x = t.pageX;
      if (x < 25 || x > window.innerWidth - 25) e.preventDefault();
    }, { passive: false });
  })();
  </script>

  <!-- ATH banner removed — too much friction, users won't save to homescreen -->
</body>
</html>
