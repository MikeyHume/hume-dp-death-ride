<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ANIM PERF TEST — Results</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0a0a0a;
    color: #33ff33;
    font-family: 'VT323', 'Courier New', monospace;
    font-size: 16px;
    line-height: 1.4;
    overflow-x: hidden;
    min-height: 100vh;
  }

  /* CRT overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      rgba(0,0,0,0.15) 0px,
      rgba(0,0,0,0.15) 1px,
      transparent 1px,
      transparent 3px
    );
    pointer-events: none;
    z-index: 1000;
  }
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at center, transparent 60%, rgba(0,0,0,0.5) 100%);
    pointer-events: none;
    z-index: 999;
  }

  .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

  .header {
    border: 2px solid #33ff33;
    padding: 16px 20px;
    margin-bottom: 20px;
    text-align: center;
    text-shadow: 0 0 8px #33ff33;
  }
  .header h1 { font-size: 28px; letter-spacing: 4px; margin-bottom: 6px; }
  .header .subtitle { font-size: 16px; color: #22aa22; }

  /* Legend */
  .legend {
    display: flex; gap: 16px; justify-content: center;
    margin-bottom: 16px; font-size: 14px; color: #888;
  }
  .legend span { display: flex; align-items: center; gap: 4px; }
  .legend-dot { display: inline-block; width: 10px; height: 10px; border-radius: 2px; }
  .legend-dot.smooth { background: #33ffaa; }
  .legend-dot.good { background: #33ff33; }
  .legend-dot.ok { background: #ffff33; }
  .legend-dot.rough { background: #ffaa33; }
  .legend-dot.bad { background: #ff3333; }

  /* Config grid */
  .config-grid {
    display: flex; flex-direction: column; gap: 2px;
    border: 1px solid #225522; padding: 8px;
    background: rgba(0,20,0,0.3);
  }

  .config-header {
    display: grid;
    grid-template-columns: 200px 60px 1fr 70px 80px 80px 80px 80px;
    gap: 8px; padding: 4px 8px;
    color: #558855; font-size: 12px;
    border-bottom: 1px solid #225522; margin-bottom: 2px;
  }

  .config-row {
    display: grid;
    grid-template-columns: 200px 60px 1fr 70px 80px 80px 80px 80px;
    align-items: center; gap: 8px;
    padding: 6px 8px;
    border-bottom: 1px solid rgba(34,85,34,0.2);
    transition: background 0.1s;
  }
  .config-row:hover { background: rgba(34,85,34,0.15); }
  .config-row.best { background: rgba(80,80,0,0.2); border: 1px solid #ffff33; }
  .config-row.crashed { background: rgba(80,0,0,0.2); }

  .c-name { font-size: 16px; font-weight: bold; }
  .c-tex { color: #558855; font-size: 14px; text-align: center; }

  .bar-container {
    height: 18px; background: #111;
    border: 1px solid #225522;
    position: relative; overflow: hidden;
  }
  .bar-fill {
    height: 100%;
    transition: width 0.5s ease-out;
    position: relative;
  }
  .bar-fill::after {
    content: '';
    position: absolute; inset: 0;
    background: repeating-linear-gradient(90deg, transparent 0px, transparent 3px, rgba(0,0,0,0.3) 3px, rgba(0,0,0,0.3) 4px);
  }
  .bar-fill.smooth { background: #33ffaa; box-shadow: 0 0 6px #33ffaa; }
  .bar-fill.good { background: #33ff33; box-shadow: 0 0 6px #33ff33; }
  .bar-fill.ok { background: #ffff33; box-shadow: 0 0 6px #ffff33; }
  .bar-fill.rough { background: #ffaa33; box-shadow: 0 0 6px #ffaa33; }
  .bar-fill.bad { background: #ff3333; box-shadow: 0 0 6px #ff3333; }

  .c-fps { text-align: right; font-size: 16px; text-shadow: 0 0 6px currentColor; }
  .c-judder { text-align: right; font-size: 14px; }
  .c-stddev { text-align: right; font-size: 13px; color: #558855; }
  .c-load { text-align: right; font-size: 13px; color: #558855; }
  .c-vram { text-align: right; font-size: 13px; color: #558855; }

  .s-smooth { color: #33ffaa; }
  .s-good { color: #33ff33; }
  .s-ok { color: #ffff33; }
  .s-rough { color: #ffaa33; }
  .s-bad { color: #ff3333; }

  /* Tags */
  .tags { display: flex; gap: 3px; flex-wrap: wrap; margin-top: 2px; }
  .tag {
    font-size: 11px; padding: 1px 4px;
    border: 1px solid #225522; color: #33aa33;
  }
  .tag.crt { border-color: #445500; color: #aaaa33; }
  .tag.half { border-color: #004455; color: #33aaff; }

  /* Recommendation */
  .recommend {
    text-align: center; padding: 14px;
    margin: 16px 0;
    border: 2px solid #ffff33;
    color: #ffff33; font-size: 20px;
    text-shadow: 0 0 10px #ffff33;
    letter-spacing: 2px;
  }

  .footer {
    text-align: center; padding: 12px; margin-top: 16px;
    color: #335533; font-size: 13px;
  }

  @keyframes flicker {
    0%, 100% { opacity: 1; }
    97% { opacity: 1; }
    98% { opacity: 0.8; }
    99% { opacity: 1; }
  }
  .container { animation: flicker 4s infinite; }
</style>
</head>
<body>
<div class="container" id="app">
  <div style="text-align:center;padding:60px 20px;color:#558855;font-size:20px" id="loading">
    LOADING RESULTS...<br>
    <code style="color:#33ff33;font-size:14px;display:block;margin-top:12px">node scripts/anim-perf-test.mjs</code>
  </div>
</div>

<script>
(async function() {
  const app = document.getElementById('app');

  let data = null;
  const sources = ['/stress/anim-perf-latest.json', '../stress/anim-perf-latest.json'];
  for (const src of sources) {
    try { const res = await fetch(src); if (res.ok) { data = await res.json(); break; } } catch {}
  }
  const params = new URLSearchParams(location.search);
  const customSrc = params.get('data');
  if (customSrc) {
    try { const res = await fetch(customSrc); if (res.ok) data = await res.json(); } catch {}
  }

  if (!data || !data.configs?.length) {
    document.getElementById('loading').innerHTML = `
      NO RESULTS FOUND<br><br>
      <span style="color:#33ff33;font-size:14px;">Run the test first:</span>
      <code style="display:block;margin-top:12px;color:#33ff33;font-size:14px;">node scripts/anim-perf-test.mjs</code>
    `;
    return;
  }

  function getClass(judder, crashed) {
    if (crashed) return 'bad';
    if (judder < 10) return 'smooth';
    if (judder < 20) return 'good';
    if (judder < 35) return 'ok';
    if (judder < 50) return 'rough';
    return 'bad';
  }

  function getIcon(cls) {
    return { bad: '☠', rough: '~', ok: '○', good: '●', smooth: '★' }[cls] || '?';
  }

  // Sort by judder (lowest first = smoothest)
  const sorted = [...data.configs].sort((a, b) => {
    if (a.avgGameFps === 0 && b.avgGameFps > 0) return 1;
    if (b.avgGameFps === 0 && a.avgGameFps > 0) return -1;
    return a.avgJudder - b.avgJudder;
  });
  const best = sorted.find(c => c.avgGameFps > 0);

  let html = `
    <div class="header">
      <h1>▓ ANIM PERF TEST ▓</h1>
      <div class="subtitle">
        ${data.device || 'Unknown'} · ${data.configs.length} configs × ${data.runsPerConfig} runs ·
        ${new Date(data.timestamp).toLocaleString()}
      </div>
    </div>

    <div class="legend">
      <span><span class="legend-dot smooth"></span> Smooth (&lt;10%)</span>
      <span><span class="legend-dot good"></span> Good (10-19%)</span>
      <span><span class="legend-dot ok"></span> OK (20-34%)</span>
      <span><span class="legend-dot rough"></span> Rough (35-49%)</span>
      <span><span class="legend-dot bad"></span> Bad (50%+)</span>
    </div>
  `;

  if (best) {
    html += `
      <div class="recommend">
        ★ SMOOTHEST: "${best.label}" — ${best.avgGameFps} FPS, ${best.avgJudder}% judder ★
      </div>
    `;
  }

  html += `
    <div class="config-grid">
      <div class="config-header">
        <span>CONFIG</span>
        <span style="text-align:center">TEX</span>
        <span>SMOOTHNESS (inverted judder)</span>
        <span style="text-align:right">FPS</span>
        <span style="text-align:right">JUDDER</span>
        <span style="text-align:right">STDDEV</span>
        <span style="text-align:right">LOAD</span>
        <span style="text-align:right">VRAM</span>
      </div>
  `;

  for (const cfg of sorted) {
    const allCrashed = cfg.avgGameFps === 0;
    const cls = getClass(cfg.avgJudder, allCrashed);
    const icon = getIcon(cls);
    const barW = allCrashed ? 0 : Math.min(100, Math.round(((60 - cfg.avgJudder) / 60) * 100));
    const isBest = cfg === best && !allCrashed;
    const rowClass = allCrashed ? 'crashed' : (isBest ? 'best' : '');

    // Tags
    let tagsHtml = `<span class="tag">${cfg.variant}</span>`;
    if (cfg.scale < 100) tagsHtml += `<span class="tag half">s${cfg.scale}</span>`;
    if (cfg.crt) tagsHtml += `<span class="tag crt">CRT</span>`;

    html += `
      <div class="config-row ${rowClass}">
        <div>
          <span class="c-name s-${cls}">${cfg.label}</span>
          <div class="tags">${tagsHtml}</div>
        </div>
        <span class="c-tex">${cfg.textureCount || '?'}</span>
        <div class="bar-container">
          <div class="bar-fill ${cls}" style="width: ${barW}%"></div>
        </div>
        <span class="c-fps s-${cls}">${allCrashed ? 'CRASH' : cfg.avgGameFps + ' FPS'}</span>
        <span class="c-judder s-${cls}">${allCrashed ? '—' : cfg.avgJudder + '%'}</span>
        <span class="c-stddev">${allCrashed ? '—' : cfg.avgStdDev.toFixed(1) + 'ms'}</span>
        <span class="c-load">${allCrashed ? '—' : cfg.avgLoadMs + 'ms'}</span>
        <span class="c-vram">${cfg.vramMB ? cfg.vramMB + 'MB' : '—'}</span>
      </div>
    `;
  }

  html += '</div>';

  // Individual runs
  html += `
    <div style="margin-top:20px;border:1px solid #225522;padding:8px;background:rgba(0,20,0,0.3);">
      <div style="color:#558855;font-size:14px;padding:4px 8px;border-bottom:1px solid #225522;margin-bottom:4px;">
        INDIVIDUAL RUNS
      </div>
  `;

  for (const cfg of sorted) {
    for (const run of cfg.runs) {
      const cls = getClass(run.animJudder, run.crashed);
      html += `
        <div style="display:grid;grid-template-columns:200px 60px 60px 60px 1fr;gap:8px;padding:2px 8px;font-size:13px;color:#447744;">
          <span>${cfg.label} #${run.run + 1}</span>
          <span class="s-${cls}">${run.crashed ? 'CRASH' : run.gameFps.toFixed(0) + ' FPS'}</span>
          <span class="s-${cls}">${run.crashed ? '—' : run.animJudder.toFixed(0) + '%'}</span>
          <span>${run.crashed ? '—' : 'σ ' + run.animStdDev.toFixed(1) + 'ms'}</span>
          <span style="color:#335533">${run.crashed ? '' : 'load ' + run.loadTimeMs + 'ms · tex ' + run.textureCount + ' · ' + run.vramMB + 'MB'}</span>
        </div>
      `;
    }
  }

  html += '</div>';

  html += `
    <div class="footer">
      Elapsed: ${data.elapsedSeconds}s · Settle: ${data.settle}s · Duration: ${data.duration}s
      <br>Run again: <code style="color:#33ff33">node scripts/anim-perf-test.mjs</code>
    </div>
  `;

  app.innerHTML = html;

  setTimeout(() => {
    document.querySelectorAll('.bar-fill').forEach((el, i) => {
      el.style.transition = `width 0.3s ease-out ${i * 50}ms`;
    });
  }, 100);
})();
</script>
</body>
</html>
